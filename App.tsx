/* tslint:disable */
import ContentContainer from '@/components/ContentContainer';
import ExampleGallery from '@/components/ExampleGallery';
import {DataContext} from '@/context';
import {Example} from '@/lib/types';
import { getYoutubeEmbedUrl, getYouTubeVideoTitle, validateYoutubeUrl, getYoutubeThumbnailUrl } from '@/lib/youtube';
import {useContext, useEffect, useMemo, useRef, useState} from 'react';

const PRESEED_CONTENT = false;
export default function App() {
  const {defaultExample, examples} = useContext(DataContext);
  const [videoUrl, setVideoUrl] = useState(PRESEED_CONTENT ? defaultExample?.url : '');
  const [videoTitle, setVideoTitle] = useState(PRESEED_CONTENT ? defaultExample?.title : '');
  const [inputError, setInputError] = useState<string | null>(null);
  const [status, setStatus] = useState<'idle' | 'validating' | 'loading'>('idle');
  const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark');
  const contentContainerRef = useRef<{ getSpec: () => string; getCode: () => string; } | null>(null);
  const [reloadCounter, setReloadCounter] = useState(0);
  const inputRef = useRef<HTMLInputElement>(null);
  const [selectedExample, setSelectedExample] = useState<Example | null>(PRESEED_CONTENT ? defaultExample : null);
  const [searchQuery, setSearchQuery] = useState('');

  useEffect(() => { document.body.className = theme; localStorage.setItem('theme', theme); }, [theme]);
  const toggleTheme = () => setTheme(prev => (prev === 'light' ? 'dark' : 'light'));
  const handleExampleSelect = (example: Example) => {
    if (inputRef.current) inputRef.current.value = example.url;
    setInputError(null); setVideoUrl(example.url); setVideoTitle(example.title); setSelectedExample(example); setReloadCounter(c => c + 1);
  };
  const handleSubmit = async () => {
    const inputValue = inputRef.current?.value.trim() || '';
    setInputError(null); setVideoTitle('');
    if (!inputValue) { inputRef.current?.focus(); return; }
    if (status !== 'idle') return;
    setStatus('validating'); setVideoUrl(''); setSelectedExample(null);
    try {
      const validation = await validateYoutubeUrl(inputValue);
      if (!validation.isValid) throw new Error(validation.error);
      const title = await getYouTubeVideoTitle(inputValue);
      setVideoTitle(title); setVideoUrl(inputValue); setReloadCounter(c => c + 1);
    } catch (err) { setInputError(err instanceof Error ? err.message : 'Invalid URL'); }
    finally { setStatus('idle'); }
  };

  const filteredExamples = useMemo(() => examples.filter(ex => ex.title.toLowerCase().includes(searchQuery.toLowerCase())), [examples, searchQuery]);
  const suggestions = useMemo(() => examples.slice(0, 3), [examples]);
  const displayItems = searchQuery ? filteredExamples : suggestions;

  const exampleGallery = <ExampleGallery onSelectExample={handleExampleSelect} selectedExample={selectedExample} />;
  const isDisabled = status !== 'idle';

  return (<><main className="main-container"><div className="left-side"><div className="title-and-controls"><div className="header-meta"><h1 className="headline">Create Your Very Own Learning App</h1><p className="attribution">Created By <strong>Dallas Slaughter</strong></p></div><button onClick={toggleTheme} className="theme-toggle" title="Toggle Theme"><div className="lightbulb"><div className="bulb-top"></div><div className="bulb-bottom"></div></div></button></div><p className="subtitle">Generate interactive learning apps from YouTube content</p><div className="input-container"><label htmlFor="youtube-url" className="sr-only">Paste a URL from YouTube:</label><div className="input-group"><input ref={inputRef} id="youtube-url" className="youtube-input" type="text" placeholder="https://www.youtube.com/watch?v=..." defaultValue={PRESEED_CONTENT ? defaultExample?.url : ''} disabled={isDisabled} onKeyDown={(e) => e.key === 'Enter' && !isDisabled && handleSubmit()} onChange={() => { setVideoUrl(''); setVideoTitle(''); setSelectedExample(null); setInputError(null); }} /><button onClick={handleSubmit} className="button-primary submit-button" disabled={isDisabled}>Create</button></div>{inputError && <p className="error-message">{inputError}</p>}</div><div className="search-and-suggestions-container"><div className="search-bar-container"><input type="search" placeholder="Or search for an example..." className="search-input" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>{displayItems.length > 0 && <div className="suggestions-list"><h3 className="suggestions-title">{searchQuery ? 'Search Results' : 'Suggestions'}</h3>{displayItems.map(example => (<div key={example.title} className="suggestion-item" onClick={() => handleExampleSelect(example)}><img src={getYoutubeThumbnailUrl(example.url)} alt={example.title} className="suggestion-thumbnail" loading="lazy" /><p className="suggestion-item-title">{example.title}</p></div>))}</div>}</div><div className="video-section">{videoTitle && <h2 className="video-title">{videoTitle}</h2>}<div className="video-container">{videoUrl ? <iframe className="video-iframe" src={getYoutubeEmbedUrl(videoUrl)} allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe> : <div className="video-placeholder"><p>Your video will appear here</p></div>}</div></div><div className="gallery-container desktop-gallery-container">{exampleGallery}</div></div><div className="right-side"><div className="content-area">{videoUrl ? <ContentContainer key={reloadCounter} contentBasis={videoUrl} onLoadingStateChange={(isLoading) => setStatus(isLoading ? 'loading' : 'idle')} preSeededSummary={selectedExample?.summary} preSeededSpec={selectedExample?.spec} preSeededComponent={selectedExample?.component} preSeededTranscript={selectedExample?.transcript} preSeededCaptions={selectedExample?.captions} preSeededChatHistory={selectedExample?.chatHistory} ref={contentContainerRef} /> : null}</div><div className="gallery-container mobile-gallery-container">{exampleGallery}</div></div></main><style>{`.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.main-container{padding:var(--space-md) var(--space-xl);display:flex;gap:var(--space-xl);height:100vh;box-sizing:border-box;overflow:hidden}@media (max-width:768px){.main-container{flex-direction:column;padding:var(--space-xl);gap:var(--space-xl);height:auto;overflow:visible}}.left-side{width:40%;height:100%;display:flex;flex-direction:column;gap:var(--space-lg);overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none}@media (max-width:768px){.left-side{width:100%;height:auto;overflow:visible}}.left-side::-webkit-scrollbar{display:none}.title-and-controls{width:100%;display:flex;align-items:flex-start;justify-content:space-between;text-align:center}.right-side{display:flex;flex-direction:column;flex:1;gap:var(--space-md);height:100%}@media (max-width:768px){.right-side{height:auto;gap:var(--space-xl)}}.headline{color:var(--color-accent);font-family:var(--font-display);font-size:1.75rem;font-weight:700;margin:0}@media (max-width:768px){.headline{font-size:1.5rem}}.subtitle{color:var(--color-text-secondary);font-size:1rem;margin:calc(-1 * var(--space-sm)) 0 0 0;text-align:center}@media (max-width:768px){.subtitle{font-size:.875rem}}.header-meta{display:flex;flex-direction:column;flex-grow:1;align-items:center}.attribution{color:var(--color-text-tertiary);font-family:var(--font-secondary);font-size:.8rem;font-weight:400;margin-top:var(--space-xs)}@media (max-width:768px){.attribution{font-size:.75rem}}.theme-toggle{background:transparent;border:none;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--color-text-primary);transition:background-color .2s;flex-shrink:0}.theme-toggle:hover{background-color:var(--color-surface-1-active)}.lightbulb{width:24px;height:24px;position:relative}.bulb-top{width:16px;height:16px;border-radius:50%;position:absolute;top:0;left:50%;transform:translateX(-50%);transition:all .3s ease}.bulb-bottom{width:10px;height:6px;border-top:none;border-radius:0 0 3px 3px;position:absolute;bottom:0;left:50%;transform:translateX(-50%);transition:all .3s ease}body.light .bulb-top{background-color:#ffc;border:2px solid #ffc;box-shadow:0 0 8px #ffc,0 0 12px #ffc}body.light .bulb-bottom{border:2px solid #999;border-top:none}body.dark .bulb-top{background-color:transparent;border:2px solid var(--color-text-secondary)}body.dark .bulb-bottom{border:2px solid var(--color-text-secondary);border-top:none}.input-container{width:100%;position:relative}.input-group{display:flex}.youtube-input{flex:1;border-right:none;border-top-right-radius:0;border-bottom-right-radius:0}.submit-button{border-top-left-radius:0;border-bottom-left-radius:0}.submit-button .material-symbols-rounded{font-size:20px}.error-message{color:var(--color-error);font-size:.9rem;margin-top:var(--space-sm);text-align:left}.search-and-suggestions-container{width:100%;padding:var(--space-md);background-color:var(--color-surface-2);border-radius:var(--border-radius-md)}.search-bar-container{position:relative;display:flex;align-items:center}.search-input{width:100%}.search-input::placeholder{user-select:none}.suggestions-list{margin-top:var(--space-md)}.suggestions-title{font-size:.8rem;font-weight:700;color:var(--color-text-secondary);margin-bottom:var(--space-sm);text-transform:uppercase;letter-spacing:.5px}.suggestion-item{display:flex;align-items:center;gap:var(--space-md);padding:var(--space-sm);border-radius:var(--border-radius-sm);cursor:pointer;transition:background-color .2s}.suggestion-item:hover{background-color:var(--color-surface-1-active)}.suggestion-thumbnail{width:80px;height:45px;object-fit:cover;border-radius:var(--border-radius-sm);flex-shrink:0}.suggestion-item-title{font-size:.9rem;font-weight:500;color:var(--color-text-primary)}.video-section{width:100%;text-align:center}.video-title{color:var(--color-text-primary);font-family:var(--font-secondary);font-size:1.1rem;font-weight:500;width:100%;margin-bottom:var(--space-sm)}.video-container{background-color:var(--color-surface-4);border-radius:var(--border-radius-md);color:var(--color-text-secondary);margin:0;padding-top:56.25%;position:relative;width:100%;overflow:hidden}.video-iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none}.video-placeholder{background-color:var(--color-surface-2);position:absolute;top:0;left:0;right:0;bottom:0;border-radius:var(--border-radius-md);border:var(--border-width-md) dashed var(--color-border-secondary);box-sizing:border-box;display:flex;align-items:center;justify-content:center;color:var(--color-text-secondary);padding:var(--space-md)}.content-area{flex:1;display:flex;flex-direction:column;max-height:100%}@media (max-width:768px){.content-area{max-height:550px;min-height:550px}}.content-placeholder{align-items:center;border:var(--border-width-sm) solid var(--color-border-secondary);border-radius:var(--border-radius-md);box-sizing:border-box;color:var(--color-text-secondary);display:flex;flex-direction:column;font-size:1.1rem;height:100%;justify-content:center;padding:0 var(--space-xl);width:100%;text-align:center}@media (max-width:768px){.content-placeholder{min-height:inherit}}.gallery-container{width:100%}.desktop-gallery-container{display:block}@media (max-width:768px){.desktop-gallery-container{display:none}}.mobile-gallery-container{display:none}@media (max-width:768px){.mobile-gallery-container{display:block}}`}</style></>);
}